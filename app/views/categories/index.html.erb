<% content_for :title, 'Categories' %>

<h1>Categories</h1>

<div class="links"><%= @total_categories %> categories identified</div>

<div class="links">
  <%= link_to 'New Category', new_category_path %>
    | Download as <%= link_to "CSV", categories_path(@filter_querystring.merge({format: "csv"})) %>
    or <%= link_to "XLSX", categories_path(@filter_querystring,format: "xlsx") %>
</div>

<div class="filter-box">
  <button id="show_filter" class="filter-button">Show/Hide Filter</button>
  <div class="filter <%="hidden" unless @filtered %>">
    <%= form_tag request.path, method: 'get' do %>
      <div class="field">
        <%= label_tag :category_name  %>
        <%= text_field_tag :category_name, params[:category_name] %>
      </div>
      <div class="field">
        <%= label_tag :summary  %>
        <%= text_field_tag :summary, params[:summary] %>
      </div>
      <div class="field">
        <%= label_tag :status %>
        <%= select_tag :category_status_type_id, options_from_collection_for_select(@category_status_types,:id,:status_text,params[:category_status_type_id]), { :include_blank => true } %>
      </div>
      <div class="field">
        <%= label_tag :response_text  %>
        <%= text_field_tag :response_text, params[:response_text] %>
      </div>
      <div class="field">
        <%= label_tag :assigned_to %>
        <%= select_tag :assigned_to, options_from_collection_for_select(@users,:id,:name,params[:assigned_to]), { :include_blank => true } %>
      </div>
      <div class="field">
        <%= label_tag :rule_change_required  %>
        <%= check_box_tag :rule_change_required, params[:rule_change_required], params[:rule_change_required] == "on" %>
      </div>
      <div class="field">
        <%= label_tag :action_needed  %>
        <%= text_field_tag :action_needed, params[:action_needed] %>
      </div>
      <div class="actions">
        <%= submit_tag "Search" %>
        <%= button_tag 'Clear Filter', {:type => 'reset', id: "clear_filter"} %>
      </div>
    <% end %>
  </div>
</div>

<%= will_paginate @categories %>
<table>
  <thead>
    <tr>
      <th>Category name</th>
      <th>Category description</th>
      <th>Category review status</th>
      <th>Response text</th>
      <th>Assigned to</th>
      <th>Rule change required?</th>
      <th>Action needed</th>
      <th># of comments</th>
      <th colspan="2"></th>
    </tr>
  </thead>

  <tbody>
    <% @categories.each_with_index do |category,index| %>
      <tr>
        <td><%= category.category_name %></td>
        <td><%= category.description %></td>
        <td class="<%= status_css(category.category_status_type)%>"><%= category.category_status_type.status_text if category.category_status_type.present? %></td>
        <td class="<%= highlight_empty_css(category.response_text)%>"><%= category.response_text %></td>
        <td class="<%= assigned_to_css(category.assigned_to) %>"><%= User.find(category.assigned_to).name if category.assigned_to.present? %></td>
        <td class="<%= highlight_filled_css(category.rule_change_required)%>"><%=category.rule_change_required ? "Y" : "N"%></td>
        <td class="<%= highlight_filled_css(category.action_needed)%>"><%= category.action_needed %></td>
        <td class="<%= highlight_empty_css(category.comments)%>"><%= category.comments.count == 0 ? "none" : link_to(category.comments.count, comments_path({category_id: category.id})) %></td>
        <td><%= link_to 'Edit', edit_category_path(category,@filter_querystring) %></td>
        <td><%= link_to 'Delete', category, method: :delete, data: { confirm: 'Are you sure?' } %></td>

        <% #<td><%= (link_to 'Move Up', "/categories/#{category.id}/move_up", method: :post) unless index == 0 % ></td> %>
        <% #<td><%= (link_to 'Move Down', "/categories/#{category.id}/move_down", method: :post) unless index == @categories.count-1 % ></td> %>
      </tr>
    <% end %>
  </tbody>
</table>
<%= will_paginate @categories %>
<br>
<div class="links">
  <%= link_to 'New Category', new_category_path %>
</div>